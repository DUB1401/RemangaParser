# Remanga Parser
**Remanga Parser** – это кроссплатформенный скрипт для получения данных с сайта [Remanga](https://remanga.org/) в формате JSON. Он позволяет записать всю информацию о конкретной манге, а также её главах и содержании глав.

## Порядок установки и использования
1. Загрузить последний релиз. Распаковать.
2. Установить Python версии не старше 3.10. Рекомендуется добавить в PATH.
3. В среду исполнения установить следующие пакеты: [random_user_agent](https://github.com/Luqman-Ud-Din/random_user_agent), [webdriver-manager](https://github.com/SergeyPirogov/webdriver_manager), [BeautifulSoup4](https://launchpad.net/beautifulsoup), [cloudscraper](https://github.com/VeNoMouS/cloudscraper), [Selenium](https://github.com/SeleniumHQ/selenium), [Pillow](https://github.com/python-pillow/Pillow).
```
pip install random_user_agent
pip install webdriver-manager
pip install BeautifulSoup4
pip install cloudscraper
pip install Selenium
pip install Pillow
```
Либо установить сразу все пакеты при помощи следующей команды, выполненной из директории скрипта.
```
pip install -r requirements.txt
```
3. Настроить скрипт путём редактирования _Settings.json_ и _Proxies.json_.
4. При использовании [Selenium](https://github.com/SeleniumHQ/selenium) для отправки запросов необходимо установить браузер [Google Chrome](https://www.google.com.iq/chrome/) в стандартную директорию на Windows, либо использовать _*.deb_ или _*.rpm_ пакет на Linux.
5. Открыть директорию со скриптом в терминале. Можно использовать метод `cd` и прописать путь к папке, либо запустить терминал из проводника.
6. Ввести нужную команду и дождаться завершения.

# Консольные команды
```
rp.py convert [FILENAME] [SOURCE_FORMAT] [OUTPUT_FORMAT]
```
Преобразует внутреннюю структуру JSON файлов определений тайтлов согласно одному из поддерживаемых форматов: [DMP-V1](Examples/DMP-V1.md), [HTCRN-V1](Examples/HTCRN-V1.md), [HTMP-V1](Examples/HTMP-V1.md), [RN-V1](Examples/RN-V1.md).

Имя файла задаётся согласно таковому в директории тайтлов, установленной настройками скрипта. Указание расширения не является обязательным.

Если вместо исходного формата указать _**-auto**_, то конвертер автоматически попытается определить формат на основании содержимого JSON.
___
```
rp.py collect [FLAGS] [KEYS]
```
Собирает коллекцию из алиасов тайтлов, соответствующих какому-то фильтру в каталоге [Remanga](https://remanga.org/). В качестве значения ключа требует ID параметра фильтрации, который можно найти в URL страницы каталога с заданным фильтром. 

Собранные алиасы добавляются в файл _Collection.txt_.

**Список специфических ключей:**
* _**--genre**_ – указывает ID жанра в качестве параметра фильтрации;
* _**--tag**_ – указывает ID тега в качестве параметра фильтрации.

**Список специфических флагов:**
* _**-f**_ – удаляет содержимое файла коллекции перед записью.
___
```
rp.py getcov [FLAGS] [MANGA_SLUG]
```
Загружает обложки конкретного тайтла.

**Список специфических флагов:**
* _**-f**_ – включает перезапись уже загруженных обложек.
___
```
rp.py manage [FORMAT] [FLAGS] [KEYS]
```
Удаляет или перемещает файлы JSON, формат которых отличается от заданного.

**Список специфических флагов:**
* _**-del**_ – указывает на то, что файлы JSON, формат которых отличается от задонного, необходимо удалить.

**Список специфических ключей:**
* _**--move**_ – указывает на то, что файлы JSON, формат которых отличается от задонного, необходимо переместить в указанную директорию.
___
```
rp.py parce [FLAGS] [MANGA_SLUG]
```
Проводит парсинг тайтла с указанным алиасом в JSON формат и загружает его обложки. В случае, если файл тайтла уже существует, дополнит его новыми данными. 

**Список специфических флагов:**
* _**-collection**_ – указывает на то, что список тайтлов для парсинга необходимо взять из файла _Collection.txt_ (заменяет собой алиас тайтла);
* _**-f**_ – включает перезапись уже загруженных обложек и существующих JSON файлов.
___
```
rp.py proxval
```
Выполняет валидацию всех установленных прокси и выводит результат на экран.

**Список специфических флагов:**
* _**-f**_ – дополнительно производит сортировку прокси внутри файла определений согласно их статусам валидации.
___
```
rp.py update [FLAGS] [KEYS]
```
Проводит парсинг тайтлов, обновлённых за интервал времени, указанный в _Settings.json_.

**Список специфических флагов:**
* _**-f**_ – включает перезапись уже загруженных обложек и существующих JSON файлов;
* _**-local**_ – обновляет все локальные файлы JSON.

**Список специфических ключей:**
* _**--from**_ – указывает алиас тайтла, с момента обнаружения которого в списке обновляемых тайтлов необходимо начать обработку обновлений, а eсли таковой не был обнаружен, скрипт пропустит все обновления.

## Неспецифические флаги
Данный тип флагов работает при добавлении к любой команде и выполняет отдельную от оной функцию.
* _**-s**_ – выключает компьютер после завершения работы скрипта.

# Settings.json
```JSON
"authorization-token": ""
```
Токен авторизации аккаунта [Remanga](https://remanga.org/) для доступа к 18+ произведениям. Получить можно из одноимённого поля заголовка GET-запросов на страницах с контентом для взрослых.
___
```JSON
"format": "dmp-v1"
```
Задаёт внутреннюю структуру описательных файлов тайтлов. Поддерживаются следующие форматы: [DMP-V1](Examples/DMP-V1.md), [HTCRN-V1](Examples/HTCRN-V1.md), [HTMP-V1](Examples/HTMP-V1.md), [RN-V1](Examples/RN-V1.md).
___
```JSON
"min-delay": 1
```
Задаёт минимальный интервал в секундах для паузы между GET-запросами к серверу.

Рекомендуемое значение: не менее 1 секунды.
___
```JSON
"max-delay": 5
```
Задаёт максимальный интервал в секундах для паузы между GET-запросами к серверу.

Рекомендуемое значение: не менее 5 секунд.
___
```JSON
"use-proxy": false
```
Указывает, следует ли использовать прокси-сервера.
___
```JSON
"selenium-mode": false
```
Переключает парсер в режим отправки запросов через интерпретатор Java Script в браузере [Google Chrome](https://www.google.com.iq/chrome/). Данный способ использует XHR для получения данных с сайта [Remanga](https://remanga.org/), что помогает обходить защиту от ботов при использовании прокси.
___
```JSON
"check-updates-period": 60
```
Указывает, обновления за какой период времени до запуска скрипта (в минутах) нужно получить.
___
```JSON
"use-id-instead-slug": false
```
При включении данного параметра файлы JSON и директория обложек тайтла будут названы по ID произведения, а не по алиасу. При этом уже существующие данные можно автоматически обновить командой `rp.py update -local`.
___
```JSON
"covers-directory": ""
```
Указывает, куда сохранять обложки тайтлов. При пустом значении будет создана папка _Covers_ в исполняемой директории скрипта. Рекомендуется оформлять в соответствии с принципами путей в Linux, описанными [здесь](http://cs.mipt.ru/advanced_python/lessons/lab02.html#cd).
___
```JSON
"titles-directory": ""
```
Указывает, куда сохранять JSON-файлы тайтлов. При пустом значении будет создана папка Titles в исполняемой директории скрипта. Рекомендуется оформлять в соответствии с принципами путей в Linux, описанными [здесь](http://cs.mipt.ru/advanced_python/lessons/lab02.html#cd).
___
```JSON
"retry-tries": 3
```
Указывает, сколко раз проводить повторные попытки при ошибке выполнения запроса.
___
```JSON
"retry-delay": 15
```
Указывает, через какой промежуток времени (в секундах) провести повторную попытку при ошибке выполнения запроса.
___
```JSON
"debug": false
```
Переключает отображение окна браузера во время выполнения запросов через [Selenium](https://github.com/SeleniumHQ/selenium).

# Proxies.json
```JSON
"selenium-validator": {
	"url": "{IP_CHECKER_URL}",
	"tag": "{IP_CONTAIER_TAG}",
	"properties": {
		"{PROPERTY_NAME}": "{PROPERTY_VALUE}"
	}
}
```
Указывает данные сайта для валидации прокси:
* _url_ – адрес сайта, определяющего IP подключения;
* _tag_ – название HTML-тега, содержащего только IP;
* _properties_ – словарное представление свойств тега для поиска IP при помощи [BeautifulSoup4](https://launchpad.net/beautifulsoup).
___
```JSON
"example": [
	{
		"https": "http://{USER_NAME}:{PASSWORD}@{IP}:{PORT}"
	},
	{
		"https": "{IP}:{PORT}"
	}
]
```
Указывает два примера настройки для публичного и приватного (требующего логин и пароль) прокси-серверов. Не влияет на работу скрипта.

> [!WARNING]  
> Несмотря на использование протокола HTTPS, в описании приватного прокси-сервера необходимо прописывать «_http://_». Это связано с особенностями распознавания настроек прокси в библиотеке [requests](https://github.com/psf/requests).
___
```JSON
"proxies": []
```
Задаёт указанные пользователем прокси-сервера для использования скриптом. При ошибках валидации, проводящейся перед каждым запросом, записи могут быть перемещены в нижеописанные разделы.
___
```JSON
"forbidden-proxies": []
```
Сюда помещаются прокси, вызывающие ошибку 403 или срабатывание капчи Cloudflare при обращении к серверу [Remanga](https://remanga.org/).
___
```JSON
"invalid-proxies": []
```
Сюда помещаются прокси, по той или иной причине не годящиеся для установления стабильной связи с сервером или отказавшие в доступе при валидации.

# Благодарность
* [@NoahDrucker](https://github.com/NoahDrucker) – библиотека установки прокси в [Selenium](https://github.com/SeleniumHQ/selenium) методом генерации браузерного дополнения.

_Copyright © DUB1401. 2022-2023._
